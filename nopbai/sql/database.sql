-- Database: bandacsan
-- Tạo CSDL nếu chưa tồn tại
CREATE DATABASE IF NOT EXISTS bandacsan CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE bandacsan;

-- ========================================================
-- 1. Bảng Users (Người dùng hệ thống)
-- ========================================================
CREATE TABLE IF NOT EXISTS users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    role VARCHAR(50) DEFAULT 'CUSTOMER' COMMENT 'ADMIN, VENDOR, CUSTOMER'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================================
-- 2. Bảng Vendors (Thông tin cửa hàng)
-- ========================================================
CREATE TABLE IF NOT EXISTS vendors (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNIQUE,
    store_name VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    description_vi TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    description_en TEXT,
    address VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    phone VARCHAR(20),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================================
-- 3. Bảng Categories (Danh mục sản phẩm)
-- ========================================================
CREATE TABLE IF NOT EXISTS categories (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name_vi VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    name_en VARCHAR(255),
    image VARCHAR(255)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================================
-- 4. Bảng Products (Sản phẩm)
-- ========================================================
CREATE TABLE IF NOT EXISTS products (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    vendor_id BIGINT,
    name_vi VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    name_en VARCHAR(255),
    description_vi TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    description_en TEXT,
    price DOUBLE,
    stock INT,
    FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng trung gian Product - Category
CREATE TABLE IF NOT EXISTS product_category (
    product_id BIGINT,
    category_id BIGINT,
    PRIMARY KEY (product_id, category_id),
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE
);

-- Bảng hình ảnh sản phẩm
CREATE TABLE IF NOT EXISTS images (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    product_id BIGINT,
    url VARCHAR(500),
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);

-- ========================================================
-- 5. Bảng Orders (Đơn hàng)
-- ========================================================
CREATE TABLE IF NOT EXISTS orders (
    id BIGINT PRIMARY KEY, -- Random ID generated by app
    user_id BIGINT,
    total_amount DOUBLE,
    status VARCHAR(50) COMMENT 'PENDING, SHIPPING, DELIVERED, CANCELLED',
    order_date DATETIME,
    shipping_address VARCHAR(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    payment_method VARCHAR(50),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS order_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_id BIGINT,
    product_id BIGINT,
    quantity INT,
    price DOUBLE,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE SET NULL
);

-- ========================================================
-- 6. Bảng Chat (Tin nhắn)
-- ========================================================
CREATE TABLE IF NOT EXISTS chat_rooms (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    vendor_id BIGINT,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS chat_messages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    room_id BIGINT,
    sender_id BIGINT,
    message TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    timestamp DATETIME,
    FOREIGN KEY (room_id) REFERENCES chat_rooms(id) ON DELETE CASCADE,
    FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE
);

-- ========================================================
-- 7. Bảng Reviews & Blog (Khác)
-- ========================================================
CREATE TABLE IF NOT EXISTS reviews (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    product_id BIGINT,
    rating INT,
    comment TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    review_date DATETIME,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS blogs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    content TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    author VARCHAR(100),
    created_at DATETIME
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================================
-- DỮ LIỆU MẪU (SEED DATA)
-- Mật khẩu mặc định là '123456' -> $2a$10$YourHashedPasswordHere (Cần thay bằng hash thật)
-- Ở đây dùng tạm hash mẫu của BCrypt cho '123456': $2a$10$eAccYoBKyQ.iO.K.1/1/1O.K.1/1/1O.K.1/1/1O.K.1/1
-- Để đơn giản, giả sử user tự đăng ký hoặc dùng code để tạo. 
-- Dưới đây chèn dữ liệu với password giả định.
-- ========================================================

-- 1. Users
INSERT INTO users (id, username, password, email, role) VALUES 
(1, 'admin', '$2a$10$eAccYoBKyQ.iO.K.1/1/1O.K.1/1/1O.K.1/1/1O.K.1/1', 'admin@bandacsan.vn', 'ADMIN'), -- Pass: 123456
(2, 'vendor1', '$2a$10$eAccYoBKyQ.iO.K.1/1/1O.K.1/1/1O.K.1/1/1O.K.1/1', 'vendor1@bandacsan.vn', 'VENDOR'),
(3, 'vendor2', '$2a$10$eAccYoBKyQ.iO.K.1/1/1O.K.1/1/1O.K.1/1/1O.K.1/1', 'vendor2@bandacsan.vn', 'VENDOR'),
(4, 'customer1', '$2a$10$eAccYoBKyQ.iO.K.1/1/1O.K.1/1/1O.K.1/1/1O.K.1/1', 'customer1@gmail.com', 'CUSTOMER'),
(5, 'customer2', '$2a$10$eAccYoBKyQ.iO.K.1/1/1O.K.1/1/1O.K.1/1/1O.K.1/1', 'customer2@gmail.com', 'CUSTOMER');

-- 2. Vendors
INSERT INTO vendors (id, user_id, store_name, description_vi, address, phone) VALUES 
(1, 2, 'Đặc Sản Tây Bắc - Cô Mị', 'Chuyên cung cấp thịt trâu gác bếp, hạt mắc khén chuẩn vị.', 'Sapa, Lào Cai', '0901234567'),
(2, 3, 'Hương Vị Miền Tây', 'Các loại mắm, trái cây sấy dẻo và bánh pía Sóc Trăng.', 'Cần Thơ', '0909888777');

-- 3. Categories
INSERT INTO categories (id, name_vi, name_en, image) VALUES 
(1, 'Đồ Khô', 'Dried Food', 'dried_food.jpg'),
(2, 'Bánh Kẹo', 'Sweets & Cakes', 'sweets.jpg'),
(3, 'Thức Uống', 'Beverages', 'drinks.jpg'),
(4, 'Gia Vị', 'Spices', 'spices.jpg');

-- 4. Products
INSERT INTO products (id, vendor_id, name_vi, name_en, description_vi, price, stock) VALUES 
(1, 1, 'Thịt Trâu Gác Bếp (500g)', 'Smoked Buffalo Meat', 'Thịt trâu tươi ướp gia vị mắc khén, hun khói tự nhiên.', 350000, 50),
(2, 1, 'Hạt Mắc Khén (100g)', 'Mac Khen Seeds', 'Gia vị đặc trưng của núi rừng Tây Bắc.', 45000, 100),
(3, 1, 'Chẩm Chéo', 'Cham Cheo Dipping Sauce', 'Muối chấm thần thánh cho các món nướng.', 25000, 200),
(4, 2, 'Bánh Pía Sóc Trăng (Túi 4 cái)', 'Pia Cake', 'Nhân sầu riêng trứng muối thơm ngon.', 65000, 80),
(5, 2, 'Mắm Cá Linh (500g)', 'Linh Fish Sauce', 'Đặc sản mùa nước nổi, dùng nấu lẩu mắm.', 50000, 60),
(6, 2, 'Rượu Sim Phú Quốc', 'Sim Wine', 'Rượu vang làm từ trái sim rừng.', 180000, 30);

-- Product Categories
INSERT INTO product_category (product_id, category_id) VALUES 
(1, 1), (2, 4), (3, 4), (4, 2), (5, 4), (6, 3);

-- 5. Orders
INSERT INTO orders (id, user_id, total_amount, status, order_date, shipping_address, payment_method) VALUES 
(1001, 4, 395000, 'DELIVERED', '2025-12-20 10:00:00', '123 Lê Lợi, Q1, TP.HCM', 'COD'),
(1002, 5, 65000, 'PENDING', '2026-01-05 14:30:00', '456 Nguyễn Trãi, Q5, TP.HCM', 'COD');

INSERT INTO order_items (order_id, product_id, quantity, price) VALUES 
(1001, 1, 1, 350000), -- 1 trâu gác bếp
(1001, 2, 1, 45000),  -- 1 mắc khén
(1002, 4, 1, 65000);  -- 1 bánh pía

-- 6. Chat
INSERT INTO chat_rooms (id, user_id, vendor_id) VALUES 
(1, 4, 1); -- Customer1 chat với Vendor1 (Cô Mị)

INSERT INTO chat_messages (room_id, sender_id, message, timestamp) VALUES 
(1, 4, 'Shop ơi, thịt trâu này bảo quản được bao lâu?', '2026-01-05 09:00:00'),
(1, 2, 'Chào bạn, nếu để ngăn đá tủ lạnh thì được 6 tháng ạ.', '2026-01-05 09:05:00'),
(1, 4, 'Dạ cảm ơn shop, để mình đặt thử.', '2026-01-05 09:06:00');

-- 7. Blogs
INSERT INTO blogs (title, content, author, created_at) VALUES 
('Top 5 Đặc Sản Làm Quà Tết 2026', 'Năm nay xu hướng quà tết là các sản phẩm tự nhiên...', 'Admin', '2026-01-01 08:00:00');
